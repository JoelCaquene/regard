{% extends "base.html" %}
{% load static %}

{% block title %}Tarefas - Cron√¥metro de Ganho Di√°rio{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1>Cron√¥metro de Ganho Di√°rio üí∞</h1>
    </div>

    <div class="task-machine-container clock-style">
        
        <div class="circular-display-container">
            <div class="circular-progress" id="circular-progress">
                <div class="progress-value" id="progress-value">
                    <i class="fas fa-clock timer-icon"></i> 
                    <div id="countdown-display" class="countdown-clock">
                        <span id="hours-display">00</span>:<span id="minutes-display">00</span>:<span id="seconds-display">00</span>
                    </div>
                </div>
            </div>
            
            {# Mensagem que aparecer√° abaixo do rel√≥gio #}
            <p id="task-message">Contagem regressiva autom√°tica de 24h.</p>
        </div>

        <div class="machine-controls">
            <div class="status-lights">
                <div class="light-indicator red-light" id="light-red"></div>
                <div class="light-indicator yellow-light" id="light-yellow"></div>
                <div class="light-indicator green-light" id="light-green"></div>
            </div>
            
            {# O bot√£o √© desabilitado/habilitado pelo JS e pela l√≥gica do Django #}
            <button id="work-button" class="action-button primary-action-button">INICIAR CICLO</button>
        </div>
    </div>

    {# --- Bloco de Informa√ß√µes do N√≠vel e Mensagem para N√ÉO-INVESTIDORES --- #}
    <div class="tasks-info">
        {% if has_active_level %}
            <p><strong>N√≠vel Ativo:</strong> {{ active_level.level.name|default:"Nenhum" }}</p>
            <p><strong>Ganho Di√°rio:</strong> <span class="gain-amount">KZ {{ active_level.level.daily_gain|default:"0.00" }}</span></p>
            <p><strong>Status do Ciclo:</strong> <span id="cycle-status">...</span></p>
        {% else %}
            {# Nova mensagem para quem n√£o tem n√≠vel ativo - REMOVENDO A INSTRU√á√ÉO ORIGINAL #}
            <p style="color: var(--warning-color);">‚ö†Ô∏è &nbsp; **M√ÅQUINA EM STANDBY.** &nbsp; ‚ö†Ô∏è</p>
            <p style="font-size: 0.9rem;">Compre um **N√≠vel/Produto** para liberar e iniciar o ciclo de ganhos di√°rios. Visite o menu **N√çVEL**.</p>
        {% endif %}
    </div>

    {# Mensagens do Django (mantido no final) #}
    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <script>
        // Vari√°vel de tempo inicial do Django (se o n√≠vel estiver ativo)
        const initialTimeRemaining = {{ cooldown_seconds_remaining|default:0 }}; 
        
        // Se o usu√°rio tem n√≠vel ativo, a m√°quina est√° "trabalhando" no ciclo; se n√£o, est√° em "idle"
        const hasActiveLevel = {{ has_active_level|lower }}; 

        document.addEventListener("DOMContentLoaded", function() {
            const workButton = document.getElementById('work-button');
            const taskMessage = document.getElementById('task-message');
            const cycleStatus = document.getElementById('cycle-status');
            const hoursDisplay = document.getElementById('hours-display');
            const minutesDisplay = document.getElementById('minutes-display');
            const secondsDisplay = document.getElementById('seconds-display');
            const circularProgress = document.getElementById('circular-progress');
            
            const lightRed = document.getElementById('light-red');
            const lightYellow = document.getElementById('light-yellow');
            const lightGreen = document.getElementById('light-green');

            const MAX_TIME = 86400; // 24 horas em segundos
            let timeRemaining = initialTimeRemaining; 
            let countdownInterval;

            // Define o estado inicial de "trabalho" baseado no tempo restante (se houver n√≠vel ativo)
            let isWorking = hasActiveLevel && timeRemaining > 0;
            let isCompleted = hasActiveLevel && timeRemaining <= 0;

            // --- FUN√á√ÉO PARA PEGAR O CSRF TOKEN DO COOKIE (MANTIDA) ---
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        let cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // --- FUN√á√ïES DE CONTROLE DE UI (ADAPTADAS) ---

            function updateLightStatus(status) {
                // status: 'idle', 'running', 'completed', 'no_level'
                lightRed.classList.remove('active', 'blinking');
                lightYellow.classList.remove('active', 'blinking');
                lightGreen.classList.remove('active', 'blinking');
                
                let buttonText = "INICIAR CICLO";
                let statusText = "INATIVO (Aguardando In√≠cio)";
                let progressColor = '#FF3D00'; // Vermelho/Laranja Inicial
                
                if (status === 'running') {
                    lightYellow.classList.add('blinking');
                    workButton.disabled = true;
                    buttonText = "CICLO EM ANDAMENTO...";
                    statusText = "ATIVO (Gerando Ganhos)";
                    progressColor = '#4CAF50'; // Verde
                } else if (status === 'completed') {
                    lightGreen.classList.add('active');
                    workButton.disabled = false;
                    buttonText = "RECEBER GANHO (Ciclo Completo)";
                    statusText = "CONCLU√çDO (Pronto para o Ganho)";
                    progressColor = '#FFC107'; // Amarelo para destacar a a√ß√£o
                } else if (status === 'no_level') {
                    // Novo estado para usu√°rios sem n√≠vel ativo
                    lightRed.classList.add('active');
                    workButton.disabled = true;
                    buttonText = "N√çVEL INATIVO";
                    statusText = "STANDBY (N√≠vel Requerido)";
                    progressColor = '#D32F2F'; // Vermelho
                } else { // 'idle' 
                    lightRed.classList.add('blinking');
                    // Se tiver n√≠vel, pode iniciar. Se n√£o tiver, desabilita.
                    workButton.disabled = hasActiveLevel ? false : true; 
                    if (!hasActiveLevel) {
                        buttonText = "N√çVEL INATIVO";
                        statusText = "STANDBY (N√≠vel Requerido)";
                        progressColor = '#D32F2F';
                    }
                }

                workButton.textContent = buttonText;
                
                // Atualiza o status de texto apenas se o usu√°rio tiver n√≠vel
                if (hasActiveLevel) {
                    cycleStatus.textContent = statusText;
                }
                
                // Se n√£o tem n√≠vel ativo, o progresso √© 0% e vermelho, e o contador √© 00:00:00
                if (!hasActiveLevel) {
                    circularProgress.style.setProperty('--progress', '0%');
                    hoursDisplay.textContent = '00';
                    minutesDisplay.textContent = '00';
                    secondsDisplay.textContent = '00';
                    taskMessage.textContent = "Ative um N√≠vel para iniciar a contagem de 24h.";
                } else {
                    circularProgress.style.background = `conic-gradient(${progressColor} var(--progress), #1e2a40 var(--progress))`;
                }
            }
            
            function formatTime(totalSeconds) {
                const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
                const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');
                return { hours, minutes, seconds };
            }

            function updateCountdownDisplay() {
                if (timeRemaining > 0) {
                    const { hours, minutes, seconds } = formatTime(timeRemaining);
                    hoursDisplay.textContent = hours;
                    minutesDisplay.textContent = minutes;
                    minutesDisplay.textContent = minutes; // Duplicado no c√≥digo original, mantido por precau√ß√£o
                    secondsDisplay.textContent = seconds;
                    taskMessage.textContent = "Pr√≥xima gera√ß√£o de lucros em...";
                    
                    const progressPercent = ((MAX_TIME - timeRemaining) / MAX_TIME) * 100;
                    circularProgress.style.setProperty('--progress', `${progressPercent}%`);
                    
                } else {
                    hoursDisplay.textContent = '00';
                    minutesDisplay.textContent = '00';
                    secondsDisplay.textContent = '00';
                    taskMessage.textContent = "CICLO COMPLETO! Clique para receber seu ganho!";
                    
                    circularProgress.style.setProperty('--progress', '100%'); 
                    
                    clearInterval(countdownInterval); 
                    updateLightStatus('completed');
                }
            }

            function startCountdown() {
                if (!hasActiveLevel) return; // N√£o inicia se n√£o tem n√≠vel ativo

                if (countdownInterval) {
                    clearInterval(countdownInterval);
                }
                
                if (timeRemaining > 0) {
                    isWorking = true;
                    updateLightStatus('running');
                    updateCountdownDisplay(); 
                    
                    countdownInterval = setInterval(() => {
                        if (timeRemaining > 0) {
                            timeRemaining--;
                            updateCountdownDisplay();
                        } else {
                            // Zerou
                            isWorking = false; // Parou de trabalhar
                            updateCountdownDisplay(); 
                        }
                    }, 1000);
                } else {
                    isWorking = false; 
                    updateCountdownDisplay(); 
                }
            }
            
            // --- FUN√á√ÉO AJAX PRINCIPAL (AGORA APONTA PARA A VIEW tarefa) ---

            function checkAndGenerateGain(isInitialStart = false) {
                if (!hasActiveLevel) {
                    taskMessage.textContent = "ERRO: N√≠vel n√£o ativo. Compre um N√≠vel para prosseguir.";
                    updateLightStatus('no_level');
                    return;
                }
                
                const csrftoken = getCookie('csrftoken'); 
                
                updateLightStatus('running'); 
                workButton.disabled = true;
                taskMessage.textContent = "Comunicando com o sistema... Aguarde.";
                
                // *** ALTERA√á√ÉO CR√çTICA: Aponta para a pr√≥pria URL 'tarefa' (que √© a view que processa o POST) ***
                fetch("{% url 'tarefa' %}", { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken 
                    },
                    body: JSON.stringify({ action: 'process_gain', is_initial_start: isInitialStart }) 
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const dailyGain = data.daily_gain || "{{ active_level.level.daily_gain|default:'0.00' }}"; 
                        
                        taskMessage.textContent = `GANHO RECEBIDO! ${data.message || 'Ciclo reiniciado.'} Ganho: KZ ${dailyGain}.`;
                        
                        // O backend agora retorna o novo tempo restante ou o tempo total (MAX_TIME)
                        timeRemaining = data.new_time_remaining || MAX_TIME; 
                        isWorking = true;
                        
                        startCountdown(); 
                        
                    } else {
                        taskMessage.textContent = data.message || "Falha ao processar a tarefa.";
                        
                        // Atualiza o tempo restante com o valor do backend, se fornecido
                        if (data.time_remaining !== undefined) {
                            timeRemaining = data.time_remaining;
                            if (timeRemaining > 0) {
                                startCountdown(); 
                            } else {
                                updateLightStatus('completed');
                            }
                        } else {
                            // Se falhou e n√£o retornou tempo, assume o estado inicial (idle ou running)
                            if (isWorking) {
                                updateLightStatus('running'); 
                            } else {
                                updateLightStatus('idle'); 
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Erro de Rede:', error);
                    taskMessage.textContent = "Erro de conex√£o. Verifique sua rede. Tente novamente.";
                    updateLightStatus('no_level'); 
                });
            }
            
            // --- INICIALIZA√á√ÉO E EVENT LISTENERS (ADAPTADOS) ---

            if (workButton) {
                workButton.addEventListener('click', function() {
                    if (hasActiveLevel) {
                        // Clica para INICIAR o ciclo (tempo <= 0) ou para receber o ganho e REINICIAR o ciclo (tempo <= 0)
                        // A √∫nica forma de o bot√£o estar habilitado √© se o tempo for <= 0 ou se for o primeiro clique.
                        checkAndGenerateGain(isInitialStart = timeRemaining <= 0); 
                    } else {
                        // Se n√£o tem n√≠vel, desativa e mostra a mensagem correta
                        updateLightStatus('no_level');
                    }
                });
            }
            
            // L√≥gica de inicializa√ß√£o unificada
            if (hasActiveLevel) {
                if (initialTimeRemaining > 0) {
                    startCountdown(); 
                } else if (initialTimeRemaining <= 0) {
                    updateLightStatus('completed');
                    taskMessage.textContent = "CICLO COMPLETO! Clique para receber seu ganho!";
                } else {
                    // Estado inicial (Tempo 0, mas pode iniciar)
                    updateLightStatus('idle'); 
                    taskMessage.textContent = "M√°quina pronta! Clique em INICIAR CICLO para come√ßar o ciclo de 24 horas.";
                }
            } else {
                // Usu√°rio sem n√≠vel ativo - Bot√£o desabilitado, luz vermelha, contador 00:00:00.
                updateLightStatus('no_level'); 
            }
        });
    </script>
</div>
{# Seu bloco de estilo original, fora de qualquer tag {% block %} para evitar o erro #}
<style>
/* ... (Seu CSS completo deve ser inclu√≠do aqui) ... */
/* ------------------------------------ */
/* ESTILOS GERAIS */
/* ------------------------------------ */
:root {
    --primary-color: #87CEEB; /* Azul Claro / Sky Blue */
    --secondary-color: #4CAF50; /* Verde */
    --dark-bg: #0d1a2f; /* Fundo Escuro */
    --medium-bg: #1a3250; /* Fundo M√©dio */
    --danger-color: #D32F2F; /* Vermelho */
    --warning-color: #FFC107; /* Amarelo */
}

.page-container { 
    padding: 10px; 
    background-color: var(--dark-bg); 
    min-height: 100vh;
    color: #fff;
}
.page-header { 
    background-color: var(--medium-bg); 
    border-bottom: 3px solid var(--primary-color); 
    padding: 15px;
    text-align: center;
    margin-bottom: 20px;
    border-radius: 8px;
}
.page-header h1 { 
    color: var(--primary-color); 
    text-shadow: 0 0 8px rgba(135, 206, 235, 0.7); 
    font-size: 1.8rem;
}
.info-box-danger { 
    background-color: var(--danger-color); 
    padding: 15px; 
    margin-top: 15px; 
    border-radius: 8px; 
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    text-align: center;
    font-weight: bold;
}
.tasks-info { 
    background-color: var(--medium-bg); 
    border: 1px solid var(--primary-color); 
    color: #fff; 
    padding: 15px; 
    margin-top: 30px; 
    border-radius: 8px; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.6); 
    text-align: center;
}
.tasks-info strong { 
    color: var(--primary-color); 
}
.tasks-info .gain-amount { 
    color: var(--secondary-color); 
    font-weight: bold; 
    font-size: 1.1rem;
}

/* ------------------------------------ */
/* ESTILO DA M√ÅQUINA CIRCULAR (REL√ìGIO) */
/* ------------------------------------ */
.task-machine-container.clock-style { 
    background: var(--medium-bg); 
    border: 4px solid var(--primary-color); 
    border-radius: 15px; 
    max-width: 350px; 
    margin: 0 auto 30px auto; 
    padding: 20px; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.8), inset 0 0 15px rgba(255, 255, 255, 0.05); 
    display: flex;
    flex-direction: column;
    align-items: center;
}

.circular-display-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 25px;
    width: 100%;
}

/* O C√çRCULO DE PROGRESSO */
.circular-progress {
    --progress: 0%; /* Vari√°vel CSS atualizada pelo JS */
    position: relative;
    height: 200px;
    width: 200px;
    border-radius: 50%;
    display: grid;
    place-items: center;
    background: conic-gradient(
        var(--secondary-color) var(--progress), 
        #1e2a40 var(--progress)
    );
    box-shadow: 0 0 15px var(--primary-color), inset 0 0 10px rgba(0,0,0,0.8);
    border: 5px solid var(--dark-bg);
}

/* O VALOR DENTRO DO C√çRCULO */
.progress-value {
    height: 180px;
    width: 180px;
    background-color: var(--dark-bg);
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 10px;
}

.timer-icon {
    font-size: 2rem;
    color: var(--primary-color);
    margin-bottom: 5px;
}

.countdown-clock { 
    font-family: 'Digital-7', monospace; /* Fonte que imita display digital */
    font-size: 2.5rem; 
    font-weight: bold; 
    color: var(--warning-color); 
    text-shadow: 0 0 10px rgba(255, 193, 7, 0.8); 
}

#task-message { 
    font-size: 0.9rem; 
    color: #ddd; 
    margin-top: 10px; 
}

/* ------------------------------------ */
/* CONTROLES E LUZES */
/* ------------------------------------ */
.machine-controls {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.status-lights { 
    margin-bottom: 25px; 
    background-color: #222; 
    border-radius: 5px; 
    padding: 10px 20px; 
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.9); 
    display: flex; 
    justify-content: space-around; 
    align-items: center; 
    width: 70%; 
}

.light-indicator { 
    width: 15px; 
    height: 15px; 
    border-radius: 50%; 
    margin: 0 10px; 
    background-color: #111; 
    transition: all 0.2s;
}

.light-indicator.active, .light-indicator.blinking { 
    border: 2px solid #fff; 
}

.light-indicator.red-light.active, .light-indicator.red-light.blinking { 
    background-color: var(--danger-color); 
    box-shadow: 0 0 12px var(--danger-color); 
}

.light-indicator.yellow-light.active, .light-indicator.yellow-light.blinking { 
    background-color: var(--warning-color); 
    box-shadow: 0 0 12px var(--warning-color); 
}

.light-indicator.green-light.active, .light-indicator.green-light.blinking { 
    background-color: var(--secondary-color); 
    box-shadow: 0 0 12px var(--secondary-color); 
}

@keyframes blinking { 
    0% { opacity: 0.3; } 
    100% { opacity: 1; } 
}

.light-indicator.blinking { 
    animation: blinking 0.8s infinite alternate; 
}

/* BOT√ÉO */
.action-button.primary-action-button { 
    background-color: var(--secondary-color); 
    background-image: linear-gradient(to top, #388E3C, #4CAF50); 
    color: #fff; 
    border: none; 
    padding: 15px 30px; 
    border-radius: 10px; 
    font-weight: bold; 
    text-transform: uppercase; 
    box-shadow: 0 5px 0 #2E7D32, 0 0 15px rgba(76, 175, 80, 0.5); 
    transition: all 0.1s ease; 
    width: 90%; 
    font-size: 1.1rem;
}
.action-button.primary-action-button:active { 
    transform: translateY(3px); 
    box-shadow: 0 2px 0 #2E7D32; 
}
.action-button.primary-action-button:disabled { 
    background-color: #555 !important; 
    background-image: none !important; 
    box-shadow: 0 5px 0 #333 !important; 
    color: #bbb; 
    cursor: not-allowed;
}
</style>
{% endblock %}

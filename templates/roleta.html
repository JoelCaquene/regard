{% extends "base.html" %}
{% load static %}

{% block title %}Roleta da Sorte M√°gica{% endblock %}

{% block content %}
<div class="roulette-page-container">
    
    <div class="magic-header">
        <h1>‚ú® Roleta da Sorte M√°gica ‚ú®</h1>
        <p class="subtitle">Gire e veja o que o destino lhe reserva. Boa sorte!</p>
    </div>

    <div class="roulette-card-container">
        
        <div class="spins-info">
            <p>Giros dispon√≠veis: <span id="roulette-spins" class="spins-count">{% if roulette_spins %}{{ roulette_spins }}{% else %}0{% endif %}</span> üéüÔ∏è</p>
        </div>
        
        {% csrf_token %}

        <div class="roulette-wheel-wrapper">
            
            <div class="roulette-pointer"></div>
            
            <img id="roulette-wheel" 
                 src="{% static 'images/roulette_wheel_segmentada.png' %}" 
                 onerror="this.onerror=null;this.src='https://placehold.co/350x350/FFEB3B/E91E63?text=ROTA+DA+SORTE';"
                 alt="Roleta da Sorte" 
                 class="roulette-wheel">
        </div>

        <button type="button" class="spin-button" id="spin-button" {% if not roulette_spins or roulette_spins <= 0 %}disabled{% endif %}>
            GIRAR AGORA! üöÄ
        </button>
        
        <div class="roulette-result" id="roulette-result"></div>
    </div>
</div>

<style>
    /* ---------------------- ESTILOS MODERNOS E PROFISSIONAIS ---------------------- */

    /* 1. Fundo da P√°gina */
    .roulette-page-container {
        padding: 20px 10px 80px 10px; /* Mais padding inferior */
        min-height: 100vh;
        background: linear-gradient(135deg, #f0f2f5 0%, #e9ecef 100%); /* Fundo suave com gradiente */
    }

    /* 2. Cabe√ßalho M√°gico */
    .magic-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
    }
    .magic-header h1 {
        font-size: 2.5rem;
        color: #3f51b5; /* Azul/Roxo Principal */
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 5px;
    }
    .subtitle {
        color: #6c757d;
        font-style: italic;
    }

    /* 3. Card da Roleta */
    .roulette-card-container {
        background-color: #ffffff;
        padding: 30px 20px;
        border-radius: 25px;
        margin: 0 auto;
        max-width: 480px;
        text-align: center;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2); /* Sombra mais profunda */
        border: 4px solid #ffc107; /* Borda Dourada Forte */
    }
    
    /* 4. Informa√ß√£o de Giros */
    .spins-info {
        font-size: 1.2rem;
        color: #495057;
        font-weight: 600;
        margin-bottom: 25px;
    }
    .spins-count {
        color: #e91e63; /* Vermelho/Pink de Destaque */
        font-weight: 900;
        font-size: 1.5rem;
        padding: 0 5px;
    }

    /* 5. Wrapper da Roda e Ponteiro */
    .roulette-wheel-wrapper {
        position: relative;
        width: 100%;
        max-width: 350px; /* Aumenta um pouco o tamanho m√°ximo */
        margin: 20px auto 40px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2); /* Sombra ao redor da roda */
        border-radius: 50%; /* Essencial para manter a forma circular */
    }
    
    /* Ponteiro (Tri√¢ngulo Moderno) */
    .roulette-pointer {
        position: absolute;
        top: -30px; /* Posi√ß√£o bem vis√≠vel acima da roda */
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 15px solid transparent; /* Aumenta o tamanho */
        border-right: 15px solid transparent;
        border-bottom: 30px solid #ff9800; /* Laranja V√≠vido */
        z-index: 10;
        filter: drop-shadow(0 0 8px rgba(255, 152, 0, 0.8)); /* Brilho */
    }

    /* Roda da Roleta REALISTA */
    .roulette-wheel {
        width: 100%;
        aspect-ratio: 1 / 1; 
        display: block;
        border-radius: 50%;
        transition: transform 5s cubic-bezier(0.1, 0.9, 0.4, 1.1); /* Anima√ß√£o mais suave e realista */
        /* Garante que o placeholder do c√≥digo (ou sua imagem real) tenha o estilo circular */
        object-fit: contain; 
        background-color: #fff; /* Fundo branco para a imagem da roleta */
    }
    
    /* 6. Bot√£o de Girar */
    .spin-button {
        padding: 18px 50px;
        background: linear-gradient(90deg, #4CAF50, #8BC34A); /* Gradiente Verde vibrante */
        color: #fff;
        border: none;
        border-radius: 10px; /* Menos arredondado para um visual moderno */
        font-size: 1.4rem;
        cursor: pointer;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.7); /* Sombra Verde */
        transition: all 0.3s ease;
    }
    .spin-button:hover:not(:disabled) {
        background: linear-gradient(90deg, #8BC34A, #4CAF50);
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.9);
    }
    .spin-button:disabled {
        background-color: #adb5bd;
        box-shadow: none;
        cursor: not-allowed;
    }

    /* 7. Resultado VIS√çVEL E FASCINANTE */
    .roulette-result {
        margin-top: 30px;
        padding: 15px 10px;
        font-size: 1.6rem;
        font-weight: 800;
        color: #fff; /* O texto deve ser branco para contrastar com o fundo do resultado */
        min-height: 40px;
        border-radius: 10px;
        opacity: 0; /* Come√ßa invis√≠vel */
        transform: scale(0.8); /* Come√ßa menor */
        transition: all 0.5s ease-out;
        background-color: transparent;
        text-shadow: 0 0 10px rgba(0,0,0,0.5);
    }

    /* Classe para o resultado BEM vis√≠vel */
    .roulette-result.show-win {
        opacity: 1;
        transform: scale(1);
        background: linear-gradient(45deg, #e91e63, #f50057); /* Fundo Vermelho/Pink */
        box-shadow: 0 0 20px #e91e63, 0 0 40px #f50057; /* Efeito de explos√£o de luz */
        animation: pulse 1s infinite alternate; /* Efeito de pulsa√ß√£o */
    }
    
    @keyframes pulse {
        from { box-shadow: 0 0 15px #f50057, 0 0 30px #e91e63; }
        to { box-shadow: 0 0 25px #f50057, 0 0 50px #e91e63; }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const spinButton = document.getElementById('spin-button');
        const rouletteWheel = document.getElementById('roulette-wheel');
        const resultDisplay = document.getElementById('roulette-result');
        const spinsDisplay = document.getElementById('roulette-spins');
        
        // CORRE√á√ÉO: Fun√ß√£o para obter o token CSRF do cookie, o m√©todo mais robusto no Django.
        function getCsrfToken() {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.startsWith('csrftoken=')) {
                        cookieValue = decodeURIComponent(cookie.substring('csrftoken='.length));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrfToken = getCsrfToken();

        // Vari√°vel para evitar m√∫ltiplos cliques enquanto gira
        let isSpinning = false; 

        if (spinButton && rouletteWheel && spinsDisplay && csrfToken) {
            
            let currentSpins = parseInt(spinsDisplay.textContent.trim()) || 0;
            
            const updateSpinButtonState = (spins) => {
                // O bot√£o s√≥ √© ativado se houver giros E n√£o estiver girando
                spinButton.disabled = spins <= 0 || isSpinning; 
            };

            updateSpinButtonState(currentSpins);

            spinButton.addEventListener('click', function() {
                if (isSpinning) return; // Ignora cliques repetidos

                currentSpins = parseInt(spinsDisplay.textContent.trim()) || 0;
                
                if (currentSpins <= 0) {
                    resultDisplay.textContent = '‚ùå Sem giros dispon√≠veis. Recarregue ou ganhe mais!';
                    updateSpinButtonState(0);
                    return;
                }
                
                // IN√çCIO DO GIRO
                isSpinning = true;
                spinButton.disabled = true;
                resultDisplay.textContent = 'Girando... ‚è≥';
                resultDisplay.classList.remove('show-win'); // Limpa a anima√ß√£o anterior

                // A L√ìGICA DE FECTH COM DJANGO PERMANECE INTACTA
                fetch('{% url "spin_roulette" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({}) 
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro na resposta do servidor (' + response.status + ')');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // L√≥gica de Anima√ß√£o Aprimorada
                        
                        // 1. Define o √¢ngulo de parada (Simula√ß√£o)
                        // Em um sistema real, o 'data.result_segment' do Django diria onde parar.
                        // Aqui, mantemos o Math.random, mas voc√™ pode substitu√≠-lo
                        // pela l√≥gica de mapeamento de √¢ngulo do seu backend (Ex: angleForSegment[data.result_segment]).
                        const baseRotations = 7; // M√≠nimo de 7 voltas para ser mais dram√°tico
                        const degrees = Math.floor(Math.random() * 360) + 360 * baseRotations;
                        
                        // 2. Aplica o giro. O CSS faz o resto.
                        rouletteWheel.style.transform = `rotate(${degrees}deg)`;

                        // 3. Espera o tempo da transi√ß√£o (5 segundos no CSS) antes de exibir o resultado
                        setTimeout(() => {
                            // FIM DO GIRO
                            isSpinning = false;

                            // Exibi√ß√£o do Resultado Fascinante
                            resultDisplay.textContent = `PARAB√âNS! Voc√™ ganhou ${data.message}`;
                            resultDisplay.classList.add('show-win'); // Adiciona a anima√ß√£o de vit√≥ria
                            
                            // Atualiza os giros e o estado do bot√£o
                            const remainingSpins = currentSpins - 1;
                            spinsDisplay.textContent = remainingSpins;
                            currentSpins = remainingSpins;
                            
                            updateSpinButtonState(currentSpins);

                        }, 5100); // 5.1s para garantir que a anima√ß√£o CSS terminou
                    } else {
                        // Caso a API retorne erro (ex: sem giros, erro do servidor)
                        isSpinning = false;
                        resultDisplay.textContent = `‚ùå Erro: ${data.message}`;
                        updateSpinButtonState(currentSpins);
                    }
                })
                .catch(error => {
                    isSpinning = false;
                    console.error('Erro de Rede/API:', error);
                    resultDisplay.textContent = 'Ocorreu um erro de comunica√ß√£o. Tente novamente.';
                    updateSpinButtonState(currentSpins);
                });
            });
        } else {
             // Mensagem de erro para o desenvolvedor
             console.error('Erro de Inicializa√ß√£o: Elementos da Roleta ou token CSRF ausentes.');
             if (resultDisplay) {
                 resultDisplay.textContent = 'Erro ao carregar a roleta (Verifique o console).';
             }
             if (spinButton) {
                 spinButton.disabled = true;
             }
        }
    });
</script>
{% endblock %}
